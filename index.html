<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Denmark Mapbox Points with Search & 3D Buildings</title>

  <!-- Mapbox GL JS CSS -->
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- Mapbox Geocoder plugin CSS -->
  <link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" />

  <style>
    /* full-screen map */
    body, html { margin:0; padding:0; height:100%; }
    #map { position:absolute; top:0; bottom:0; width:100%; }

    /* search box container at top-left */
    .geocoder-container { position:absolute; top:10px; left:10px; width:250px; max-width:90%; z-index:2; }

    /* popup styling */
    .mapboxgl-popup { max-width:300px; }
    .mapboxgl-popup-content { max-height:200px; overflow-y:auto; padding:8px; box-sizing:border-box; }
    .mapboxgl-popup-content dl { margin:0; font-family:sans-serif; }
    .mapboxgl-popup-content dt { font-weight:bold; margin-top:6px; }
    .mapboxgl-popup-content dd { margin:0 0 6px 8px; }
  </style>
</head>
<body>
  <!-- Geocoder input -->
  <div id="geocoder" class="geocoder-container"></div>
  <!-- Map container -->
  <div id="map"></div>

  <!-- Mapbox GL JS -->
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <!-- Mapbox Geocoder plugin JS -->
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>

  <script>
    // Mapbox access token
    mapboxgl.accessToken = 'pk.eyJ1Ijoia2FydGFnbyIsImEiOiJjbWEzeW1wNmowMWpqMmlzNGs3Y3B0eWdrIn0.oDybv3cDzWQ0sjd9eVBzKw';

    // Initialize the map with 3D perspective using the default Streets style
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [10.0, 56.0],
      zoom: 6,
      pitch: 45,
      bearing: -17.6
    });
    map.addControl(new mapboxgl.NavigationControl());

    map.on('load', () => {
      // Add 3D buildings layer beneath label layers
      const layers = map.getStyle().layers;
      let labelLayerId;
      for (const layer of layers) {
        if (layer.type === 'symbol' && layer.layout['text-field']) {
          labelLayerId = layer.id;
          break;
        }
      }
      map.addLayer({
        id: '3d-buildings',
        source: 'composite',
        'source-layer': 'building',
        filter: ['==', 'extrude', 'true'],
        type: 'fill-extrusion',
        minzoom: 15,
        paint: {
          'fill-extrusion-color': '#f3eee8',
          'fill-extrusion-height': ['interpolate', ['linear'], ['zoom'], 15, 0, 15.05, ['get', 'height']],
          'fill-extrusion-base': ['interpolate', ['linear'], ['zoom'], 15, 0, 15.05, ['get', 'min_height']],
          'fill-extrusion-opacity': 1
        }
      }, labelLayerId);

      // Load points and add as geojson source + circle layer
      fetch('data/points.geojson')
        .then(res => res.json())
        .then(geojson => {
          map.addSource('points', { type: 'geojson', data: geojson });
          map.addLayer({
            id: 'points-layer',
            type: 'circle',
            source: 'points',
            paint: {
              'circle-radius': ['case', ['boolean', ['feature-state','highlight'], false], 12, 6],
              'circle-color': ['case', ['boolean', ['feature-state','highlight'], false], '#ff5200', '#007cbf']
            }
          });

          // Cursor feedback and popup
          map.on('mouseenter', 'points-layer', () => map.getCanvas().style.cursor = 'pointer');
          map.on('mouseleave', 'points-layer', () => map.getCanvas().style.cursor = '');
          map.on('click', 'points-layer', e => {
            const coords = e.features[0].geometry.coordinates.slice();
            const props = e.features[0].properties;
            let html = '<dl style="margin:0;">';
            for (const k in props) {
              html += `<dt style="font-weight:bold;">${k}</dt><dd>${String(props[k]).replace(/\n/g, '<br>')}</dd>`;
            }
            html += '</dl>';
            new mapboxgl.Popup({ offset: 15 }).setLngLat(coords).setHTML(html).addTo(map);
          });

          // Add Mapbox Geocoder control for searching points
          const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            placeholder: 'Search by Navnâ€¦',
            marker: false,
            localGeocoder: query => {
              const term = query.trim().toLowerCase();
              return geojson.features
                .filter(f => f.properties.Navn.toLowerCase().includes(term))
                .map(f => ({ place_name: f.properties.Navn, center: f.geometry.coordinates, properties: f.properties }));
            },
            zoom: 12
          });
          document.getElementById('geocoder').appendChild(geocoder.onAdd(map));
          let highlightId = null;
          geocoder.on('result', ev => {
            if (highlightId !== null) {
              map.setFeatureState({ source:'points', id: highlightId }, { highlight: false });
            }
            const sel = ev.result.properties.Navn;
            const feature = geojson.features.find(f => f.properties.Navn === sel);
            highlightId = feature.id;
            map.setFeatureState({ source:'points', id: highlightId }, { highlight: true });
            map.flyTo({ center: ev.result.center, zoom:12 });
          });
        });
    });
  </script>
</body>
</html>
