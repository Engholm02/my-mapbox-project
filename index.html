<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Denmark Mapbox Points with Responsive Controls & Scrollable Popups</title>

  <!-- Mapbox GL JS CSS -->
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- Mapbox Geocoder plugin CSS -->
  <link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" />

  <style>
    /* Fullscreen map */
    body, html { margin:0; padding:0; height:100%; }
    #map { position:absolute; top:0; bottom:0; width:100%; }

    /* Top-left control container: full-width up to 980px with 24px top margin */
    .mapboxgl-ctrl-top-left {
      top: 24px;
      left: 50% !important;
      transform: translateX(-50%);
      width: 100%;
      max-width: 980px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      padding: 0 0px;
      box-sizing: border-box;
      z-index: 2;
    }

    /* Remove margins on control elements */
    .mapboxgl-ctrl-group,
    .mapboxgl-ctrl-group button,
    .mapboxgl-ctrl-geocoder {
      margin: 0 !important;
      padding: 0 !important;
    }

    /* Fixed height for geocoder container */
    .mapboxgl-ctrl-geocoder {
      flex: 1;
      height: 40px;
      box-sizing: border-box;
    }
    /* Input spans full height */
    .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input {
      width: 100%;
      height: 100%;
      margin: 0;
      box-sizing: border-box;
    }
    /* Suggestions box */
    .mapboxgl-ctrl-geocoder .suggestions {
      margin: 0;
      box-sizing: border-box;
    }

    /* Popup styling: fixed height and scrollable content */
    .mapboxgl-popup {
      max-width: 300px;
    }
    .mapboxgl-popup-content {
      max-height: 200px;  /* adjust as needed */
      overflow-y: auto;
      padding: 8px;
      box-sizing: border-box;
      font-family: sans-serif;
    }
    .mapboxgl-popup-content dl { margin:0; }
    .mapboxgl-popup-content dt { font-weight:bold; margin-top:6px; }
    .mapboxgl-popup-content dd { margin:0 0 6px 8px; }
  </style>
</head>
<body>
  <!-- Map container -->
  <div id="map"></div>

  <!-- Mapbox GL JS -->
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <!-- Mapbox Geocoder plugin JS -->
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>

  <script>
    // Mapbox public token with styles:read and tilesets:read
    mapboxgl.accessToken = 'pk.eyJ1Ijoia2FydGFnbyIsImEiOiJjbWEzeW1wNmowMWpqMmlzNGs3Y3B0eWdrIn0.oDybv3cDzWQ0sjd9eVBzKw';

    // Initialize map
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [10.0, 56.0],
      zoom: 6,
      pitch: 0,
      bearing: -17.6
    });
    map.addControl(new mapboxgl.NavigationControl(), 'top-left');

    // Add geocoder control in same top-left container
    const geocoder = new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapboxgl: mapboxgl,
      placeholder: 'Search by Navn…',
      marker: false,
      zoom: 12,
      localGeocoder: query => {
        const term = query.trim().toLowerCase();
        return pointsData.features
          .filter(f => f.properties.Navn.toLowerCase().includes(term))
          .map(f => ({ place_name: f.properties.Navn, center: f.geometry.coordinates }));
      }
    });
    map.addControl(geocoder, 'top-left');

    // Error logging
    map.on('error', e => console.error('Map error:', e.error && e.error.message));

    // Once map loads, add 3D buildings and points
    let pointsData;
    map.on('load', () => {
      // 3D buildings
      const layers = map.getStyle().layers;
      let labelLayerId;
      for (const layer of layers) {
        if (layer.type === 'symbol' && layer.layout['text-field']) {
          labelLayerId = layer.id;
          break;
        }
      }
      map.addLayer({
        id: '3d-buildings',
        source: 'composite',
        'source-layer': 'building',
        filter: ['==', 'extrude', 'true'],
        type: 'fill-extrusion',
        minzoom: 15,
        paint: {
          'fill-extrusion-color': '#f3eee8',
          'fill-extrusion-height': ['interpolate', ['linear'], ['zoom'], 15, 0, 15.05, ['get', 'height']],
          'fill-extrusion-base': ['interpolate', ['linear'], ['zoom'], 15, 0, 15.05, ['get', 'min_height']],
          'fill-extrusion-opacity': 1
        }
      }, labelLayerId);

      // Load and add points
      fetch('data/points.geojson')
        .then(res => res.json())
        .then(geojson => {
          pointsData = geojson;
          map.addSource('points', { type: 'geojson', data: geojson });
          map.addLayer({
            id: 'points-layer',
            type: 'circle',
            source: 'points',
            
            paint: {
              'circle-radius': ['case', ['boolean', ['feature-state','highlight'], false], 12, 6],
              'circle-color': ['case', ['boolean', ['feature-state','highlight'], false], '#ff5200', '#007cbf']
            }
          });

      // ▼ samvær layer (dark-blue)
      map.addSource('samvaer', {
        type: 'geojson',
        data: 'data/samvaer.geojson'
      });
      map.addLayer({
        id: 'samvaer-layer',
        type: 'circle',
        source: 'samvaer',
        paint: {
          'circle-radius': 6,
          'circle-color': '#00008B'
        }
      });

      // popups for samvær
      map.on('mouseenter', 'samvaer-layer', () => map.getCanvas().style.cursor = 'pointer');
      map.on('mouseleave', 'samvaer-layer', () => map.getCanvas().style.cursor = '');
      map.on('click', 'samvaer-layer', (e) => {
        const coords = e.features[0].geometry.coordinates.slice();
        const props  = e.features[0].properties;
        let html = '<dl style="margin:0;">';
        for (const k in props) {
          html += `<dt style="font-weight:bold;">${k}</dt><dd>${String(props[k]).replace(/\\n/g,'<br>')}</dd>`;
        }
        html += '</dl>';
        new mapboxgl.Popup({ offset:15 }).setLngLat(coords).setHTML(html).addTo(map);
      });

          // Cursor & popups
          map.on('mouseenter', 'points-layer', () => map.getCanvas().style.cursor = 'pointer');
          map.on('mouseleave', 'points-layer', () => map.getCanvas().style.cursor = '');
          map.on('click', 'points-layer', e => {
            const coords = e.features[0].geometry.coordinates.slice();
            const props = e.features[0].properties;
            let html = '<dl style="margin:0;">';
            for (const k in props) {
              html += `<dt style="font-weight:bold;">${k}</dt><dd>${String(props[k]).replace(/\n/g, '<br>')}</dd>`;
            }
            html += '</dl>';
            new mapboxgl.Popup({ offset: 15 }).setLngLat(coords).setHTML(html).addTo(map);
          });

          // Highlight on geocoder result
          let highlightId = null;
          geocoder.on('result', ev => {
            if (highlightId !== null) map.setFeatureState({ source:'points', id: highlightId }, { highlight: false });
            const match = pointsData.features.find(f => f.properties.Navn === ev.result.place_name);
            highlightId = match.id;
            map.setFeatureState({ source:'points', id: highlightId }, { highlight: true });
            map.flyTo({ center: ev.result.center, zoom: 12 });
          });
        });
    });
  </script>
</body>
</html>