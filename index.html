<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kartago Map</title>

  <!-- Mapbox GL JS CSS -->
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- Mapbox Geocoder plugin CSS -->
  <link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" />

  <style>

    /* Fullscreen map */
    body, html { margin:0; padding:0; height:100%; }
    #map { position:absolute; top:0; bottom:0; width:100%; }


    /* Top-left control container: full-width up to 980px, centered with margin */
    .mapboxgl-ctrl-top-left {
      top: 24px;
      left: 50% !important;
      transform: translateX(-50%);
      width: 100%;
      max-width: 980px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 0 24px;
      box-sizing: border-box;
      z-index: 2;
    }


    /* Remove margins on control elements */
    .mapboxgl-ctrl-group,
    .mapboxgl-ctrl-group button,
    .mapboxgl-ctrl-geocoder {
      margin: 0 !important;
      padding: 0 !important;
    }


    /* Fixed height for geocoder container */
    .mapboxgl-ctrl-geocoder {
      flex: 1;
      height: 40px;
      box-sizing: border-box;
    }


    /* Input spans full height */
    .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input {
      width: 100%;
      height: 100%;
      margin: 0;
      box-sizing: border-box;


    }
    /* Suggestions box */
    .mapboxgl-ctrl-geocoder .suggestions {
      margin: 0;
      box-sizing: border-box;
      max-height: 500px;
      overflow-y: auto;
    }

    /* Popup styling: fixed height and scrollable content */
    .mapboxgl-popup {
      max-width: 300px;
      overflow: hidden; /* Hide Scrollbars */
      box-shadow: rgba(0, 0, 0, 0.15) 0px 0px 40px 0px;
    }
    .mapboxgl-popup-content {
      max-height: 200px;  /* adjust as needed */
      overflow-y: auto;
      padding: 12px;
      box-sizing: border-box;
      font-family: sans-serif;
    }
    .mapboxgl-popup-content dl { margin:0; }
    .mapboxgl-popup-content dt { font-weight:bold; margin-top:6px; }
    .mapboxgl-popup-content dd { margin:0 0 16px 0px; }

    /* --- Added for popup sections --- */
    .popup-section {
      margin-bottom: 16px;
    }
    .popup-section h4 {
      font-size: 14px;
      margin-bottom: 4px;
      color: #333;
    }

    /* Centered modal-style popup override */
    .mapboxgl-popup.central-popup {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      width: 400px !important;
      max-width: 90vw !important;
      max-height: 400px;
      z-index: 1000;
      pointer-events: auto !important;
    }

    /* Fixed-position left popup list for multiple features */
    .popup-list-left {
      position: fixed;
      top: 120px;
      left: 24px;
      width: 300px;
      max-height: 350px;
      overflow-y: scroll;
      -webkit-overflow-scrolling: touch;
      background: white;
      border-radius: 4px;
      box-shadow: rgba(0, 0, 0, 0.15) 0px 0px 40px 0px;
      padding: 24px;
      font-family: sans-serif;
      font-size: 12px;
      z-index: 999;
      transition: opacity 0.3s ease;
      opacity: 1;
      gap: 12px;
      display: flex;
      flex-direction: column;
    }
    .popup-list-filter {
      margin-bottom: 10px;
      padding: 6px;
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
    }

    .popup-list-filter::-webkit-search-cancel-button {
      -webkit-appearance: none;
    }
    .popup-list-filter::-ms-clear {
      display: none;
    }
    .popup-list-filter::-moz-clear {
      display: none;
    }

    @media (max-width: 600px) {
      .popup-list-left {
        left: 0;
        right: 0;
        top: auto;
        bottom: 0;
        width: 100%;
        height: auto;
        max-height: 60vh;
        touch-action: pan-y;
        border-radius: 12px 12px 0 0;
      }
    }
    /* Hover preview popup styling */
    .mapboxgl-popup.hover-popup {
      pointer-events: none;
      background: transparent;
      box-shadow: none;
    }
    .mapboxgl-popup.hover-popup .mapboxgl-popup-content {
      background: white;
      padding: 6px 8px;
      border-radius: 4px;
      box-shadow: rgba(0, 0, 0, 0.1) 0 2px 8px;
    }
    .mapboxgl-popup.hover-popup .mapboxgl-popup-tip {
      display: none;
    }

    /* Close button for left popup list */
    .popup-list-left .popup-list-close {
      position: absolute;
      top: 28px !important;
      right: 30px !important;
      background: none;
      border: none;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      color: #666;
      line-height: 1;
    }


    .mapboxgl-popup-content {
      max-height: 80vh;
      overflow-y: auto;
      padding: 16px;
    }

    /* Hide the little arrow tip */
    .mapboxgl-popup-tip {
      display: none;
    }

    /* Prevent body scroll when popup is open */
    body.popup-open {
      overflow: hidden;
      touch-action: none;
    }

    /* Larger close button */
    .mapboxgl-popup-close-button {
      width: 32px;
      height: 32px;
      font-size: 24px;
    }

    @media (max-width: 600px) {
      .mapboxgl-popup.central-popup {
        top: 0 !important;
        left: 0 !important;
        transform: none !important;
        width: 100vw !important;
        height: 100vh !important;
        max-height: 100vh;
        border-radius: 0;
      }

      .mapboxgl-popup-content {
        max-height: 100vh;
        height: 100%;
        overflow-y: auto;
        padding: 16px;
      }

      .mapboxgl-popup-close-button {
        position: absolute;
        top: 16px;
        right: 16px;
        font-size: 24px;
        background: none;
        border: none;
        color: #666;
        z-index: 2;
      }
    }

  </style>
</head>
<body>
  <!-- Map container -->
  <div id="map"></div>

  <!-- Mapbox GL JS -->
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <!-- Mapbox Geocoder plugin JS -->
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>

  <!-- Layer toggle and kommune filter handlers -->
  <script>
    // Funktion til at sætte samme filter på alle relevante lag, med forsinkelse og lag-tjek
    function applyFilterToAllLayers(property, value) {
      const layers = [
        '104_geocoded-layer',
        '105_geocoded-layer',
        '107_geocoded-layer',
        '108_geocoded-layer',
        '108a_geocoded-layer'
      ];

      const actualProperty = property === 'kommune' ? 'Kommune' : property;

      // Forsinket udførelse for at sikre at lag er indlæst
      setTimeout(() => {
        layers.forEach(layerId => {
          const layer = map.getLayer(layerId);
          if (!layer) {
            console.warn(`Lag ikke fundet endnu: ${layerId}`);
            return;
          }

          if (value === '') {
            map.setFilter(layerId, null);
          } else {
            console.log(`Anvender filter på ${layerId}: ${actualProperty} = ${value}`);
            map.setFilter(layerId, ['==', ['get', actualProperty], value]);
          }
        });
      }, 500); // Vent 500 ms for at sikre at lagene er klar

      // Dynamisk udfyldning af kommune-dropdown efter alle pointsData er hentet
      function populateKommuneDropdown() {
        const dropdown = document.getElementById('filter-kommune');
        if (!dropdown) return;

        const allPoints = [pointsData, pointsData2, pointsData3, pointsData4].filter(Boolean);
        const kommuneSet = new Set();

        allPoints.forEach(source => {
          if (!source || !source.features) return;
          source.features.forEach(f => {
            const k = f.properties.Kommune || f.properties.kommune;
            if (typeof k === 'string' && k.trim() !== '') {
              kommuneSet.add(k.trim());
            }
          });
        });

        const sortedKommuner = Array.from(kommuneSet).sort();
        dropdown.innerHTML = '<option value=\"\">Alle</option>' +
          sortedKommuner.map(k => `<option value=\"${k}\">${k}</option>`).join('');
      }

      // Kald efter vi ved dataen er klar
      setTimeout(populateKommuneDropdown, 1000); // giver data tid til at loade
    }

    // Globalt lagersynligheds-objekt
    window.layerVisibility = {
      'boliga_geocoded-layer': true,
      'ejendomstorvet_geocoded-layer': true,
      '104_geocoded-layer': true,
      '105_geocoded-layer': true,
      '107_geocoded-layer': true,
      '108_geocoded-layer': true,
      '108a_geocoded-layer': true,
      '108s_geocoded-layer': true,
      'autisme_heatmap_layer': true,
      'autisme_heatmap_unge_layer': true
    };

    // Global toggle-funktion
    window.handleToggleClick = function(id) {
      const idMap = {
        'toggle-boliga': 'boliga_geocoded-layer',
        'toggle-ejendomstorvet': 'ejendomstorvet_geocoded-layer',
        'toggle-104': '104_geocoded-layer',
        'toggle-105': '105_geocoded-layer',
        'toggle-107': '107_geocoded-layer',
        'toggle-108': '108_geocoded-layer',
        'toggle-108a': '108a_geocoded-layer',
        'toggle-108s': '108s_geocoded-layer',
        'toggle-voksne': 'autisme_heatmap_layer',
        'toggle-unge': 'autisme_heatmap_unge_layer'
      };
      const layerId = idMap[id];
      if (!layerId) return;

      window.layerVisibility[layerId] = !window.layerVisibility[layerId];
      if (map.getLayer(layerId) && map.getLayer(layerId).type !== 'heatmap') {
        map.setLayoutProperty(layerId, 'visibility', window.layerVisibility[layerId] ? 'visible' : 'none');
      }
      // Specialhåndtering for heatmap layers (eller hvis vi ønsker at bruge visibility direkte)
      else if (map.getLayer(layerId)) {
        map.setLayoutProperty(layerId, 'visibility', window.layerVisibility[layerId] ? 'visible' : 'none');
      }

      const button = document.getElementById(id);
      if (button) {
        const checked = button.querySelector('.checked');
        const unchecked = button.querySelector('.unchecked');
        if (checked && unchecked) {
          checked.style.display = window.layerVisibility[layerId] ? 'block' : 'none';
          unchecked.style.display = window.layerVisibility[layerId] ? 'none' : 'block';
        }
      }
    };

    // Lyt efter postMessage events og håndter filter og toggles samlet (GAMMEL STRUKTUR med action)
    window.addEventListener('message', function(event) {
      const { action, value } = event.data;

      const toggleIds = [
        'toggle-boliga',
        'toggle-ejendomstorvet',
        'toggle-104',
        'toggle-105',
        'toggle-107',
        'toggle-108',
        'toggle-108a',
        'toggle-108s',
        'toggle-voksne',
        'toggle-unge'
      ];

      if (toggleIds.includes(action)) {
        window.handleToggleClick(action);
      }

      if (action === 'filter-kommune') {
        applyFilterToAllLayers('Kommune', value);
      }

      if (action === 'filter-by') {
        applyFilterToAllLayers('by', value);
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      // Klik-handling på knapperne
      [
        'toggle-boliga',
        'toggle-ejendomstorvet',
        'toggle-104',
        'toggle-105',
        'toggle-107',
        'toggle-108',
        'toggle-108a',
        'toggle-108s',
        'toggle-voksne',
        'toggle-unge'
      ].forEach((id) => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.addEventListener('click', () => window.handleToggleClick(id));
        }
      });

      // Event delegation fallback (in case elements were not present at load)
      document.addEventListener('click', (e) => {
        const target = e.target.closest(
          '#toggle-boliga, #toggle-ejendomstorvet, #toggle-104, #toggle-105, #toggle-107, #toggle-108, #toggle-108a, #toggle-108s, #toggle-voksne, #toggle-unge'
        );
        if (target) {
          window.handleToggleClick(target.id);
        }
      });

      // Kommune-dropdown filtrering
      const kommuneDropdown = document.getElementById('filter-kommune');
      if (kommuneDropdown) {
        kommuneDropdown.addEventListener('change', function () {
          const selectedKommune = this.value;
          applyFilterToAllLayers('Kommune', selectedKommune);
        });
      }
    });
  </script>

  <script>
    // Mapbox public token with styles:read and tilesets:read
    mapboxgl.accessToken = 'pk.eyJ1Ijoia2FydGFnbyIsImEiOiJjbWEzeW1wNmowMWpqMmlzNGs3Y3B0eWdrIn0.oDybv3cDzWQ0sjd9eVBzKw';

    // Initialize map
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [10.0, 56.0],
      zoom: 6,
      pitch: 0,
      bearing: 0
    });
    // Global popup variable for central popups
    let currentPopup = null;
    let pointsData;
    let pointsData2;
    let pointsData3;
    let pointsData4;
    let pointsData5;
    let pointsData6;
    let pointsData7;

    // Add geocoder control in same top-left container
    const geocoder = new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapboxgl: mapboxgl,
      placeholder: 'Søg i dine data…',
      marker: false,
      zoom: 12,
      localGeocoder: function (query) {
        const matchingFeatures = [];
        const seenKommuner = new Set();
        const allSources = [
          { name: '104', data: pointsData },
          { name: '105', data: pointsData2 },
          { name: 'boliga', data: pointsData3 },
          { name: 'ejendomstorvet', data: pointsData4 },
          { name: '108', data: pointsData5 },
          { name: '108a', data: pointsData6 },
          { name: '108s', data: pointsData7 }
        ];
        const lowerQuery = (query || '').toLowerCase();

        allSources.forEach(({ data }) => {
          if (!data || !data.features) return;

          data.features.forEach(feature => {
            const props = feature.properties || {};
            const kommune = props['Kommune'] || '[Ukendt Kommune]';
            const navn = props['Navn'] || '[Ukendt Navn]';
            const match = Object.entries(props).some(([_, value]) =>
              typeof value === 'string' && value.toLowerCase().includes(lowerQuery)
            );

            if (match && feature.geometry && Array.isArray(feature.geometry.coordinates)) {
              // Tilføj kommune-søgning én gang per kommune
              const kommuneKey = kommune.toLowerCase().trim();
              if (!seenKommuner.has(kommuneKey) && kommuneKey.includes(lowerQuery)) {
                seenKommuner.add(kommuneKey);
                matchingFeatures.push({
                  place_name: kommune,
                  center: feature.geometry.coordinates,
                  geometry: {
                    type: 'Point',
                    coordinates: feature.geometry.coordinates
                  },
                  properties: {
                    filterType: 'kommune'
                  }
                });
              }

              // Tilføj ALLE botilbud med navn – men uden at trigge kommune-filtrering
              const label = `${navn} – ${kommune}`;
              matchingFeatures.push({
                place_name: label,
                center: feature.geometry.coordinates,
                geometry: {
                  type: 'Point',
                  coordinates: feature.geometry.coordinates
                },
                properties: {
                  filterType: 'botilbud'
                }
              });
            }
          });
        });

        return matchingFeatures;
      },
      types: 'local',
      localGeocoderOnly: true
    });
    map.addControl(geocoder, 'top-left');

    // Error logging
    map.on('error', e => console.error('Map error:', e.error && e.error.message));

    // Once map loads, add 3D buildings and points
    map.on('load', () => {
      // Tilføj kilde til ASF heatmap
      map.addSource('autisme_heatmap', {
        type: 'geojson',
        data: 'data/autisme_voksne.geojson'
      });
      // Tilføj kilde til ASF heatmap for unge
      map.addSource('autisme_heatmap_unge', {
        type: 'geojson',
        data: 'data/autisme_unge.geojson'
      });

      // Tilføj heatmap-lag
      map.addLayer({
        id: 'autisme_heatmap_layer',
        type: 'heatmap',
        source: 'autisme_heatmap',
        maxzoom: 12,
        paint: {
          'heatmap-weight': [
            'interpolate',
            ['linear'],
            ['get', 'Andel_ASF_2022_pct'],
            0.5, 0,
            2.0, 1
          ],
          'heatmap-intensity': [
            'interpolate',
            ['linear'],
            ['zoom'],
            0, 1,
            9, 3
          ],
          'heatmap-color': [
            'interpolate',
            ['linear'],
            ['heatmap-density'],
            0, 'rgba(33,102,172,0)',
            0.2, 'rgb(103,169,207)',
            0.4, 'rgb(209,229,240)',
            0.6, 'rgb(253,219,199)',
            0.8, 'rgb(239,138,98)',
            1, 'rgb(178,24,43)'
          ],
          // Interpolate heatmap-radius based on a property, e.g. 'Antal'
          'heatmap-radius': [
            'interpolate',
            ['linear'],
            ['get', 'Antal'],
            0, 5,
            50, 20,
            100, 50
          ],
          'heatmap-opacity': 0.7
        }
      }, 'waterway-label');
      // Tilføj heatmap-lag for unge
      map.addLayer({
        id: 'autisme_heatmap_unge_layer',
        type: 'heatmap',
        source: 'autisme_heatmap_unge',
        maxzoom: 12,
        paint: {
          'heatmap-weight': [
            'interpolate',
            ['linear'],
            ['get', 'Antal'],
            0, 0,
            50, 1
          ],
          'heatmap-intensity': [
            'interpolate',
            ['linear'],
            ['zoom'],
            0, 1,
            9, 3
          ],
          'heatmap-color': [
            'interpolate',
            ['linear'],
            ['heatmap-density'],
            0, 'rgba(33,102,172,0)',
            0.2, 'rgb(103,169,207)',
            0.4, 'rgb(209,229,240)',
            0.6, 'rgb(253,219,199)',
            0.8, 'rgb(239,138,98)',
            1, 'rgb(178,24,43)'
          ],
          'heatmap-radius': [
            'interpolate',
            ['linear'],
            ['get', 'Antal'],
            0, 5,
            50, 20,
            100, 50
          ],
          'heatmap-opacity': 0.7
        }
      }, 'waterway-label');
      // Sørg for at heatmaps ligger øverst
      map.moveLayer('autisme_heatmap_layer');
      map.moveLayer('autisme_heatmap_unge_layer');

      // Tilføj usynligt punktlag til klik for voksne
      map.addLayer({
        id: 'autisme_points_voksne_layer',
        type: 'circle',
        source: 'autisme_heatmap',
        paint: {
          'circle-radius': 8,
          'circle-color': 'rgba(0,0,0,0)',
          'circle-opacity': 0
        }
      });

      // Tilføj usynligt punktlag til klik for unge
      map.addLayer({
        id: 'autisme_points_unge_layer',
        type: 'circle',
        source: 'autisme_heatmap_unge',
        paint: {
          'circle-radius': 8,
          'circle-color': 'rgba(0,0,0,0)',
          'circle-opacity': 0
        }
      });

      // Popup for voksne
      map.on('click', 'autisme_points_voksne_layer', function(e) {
        const props = e.features[0].properties;
        console.log('Autisme voksne properties:', props);
        let html = '<dl>';
        for (const key in props) {
          html += `<dt>${key}</dt><dd>${props[key]}</dd>`;
        }
        html += '</dl>';
        new mapboxgl.Popup({ offset: 15 })
          .setLngLat(e.lngLat)
          .setHTML(html)
          .addTo(map);
      });
      map.on('mouseenter', 'autisme_points_voksne_layer', () => map.getCanvas().style.cursor = 'pointer');
      map.on('mouseleave', 'autisme_points_voksne_layer', () => map.getCanvas().style.cursor = '');

      // Popup for unge
      map.on('click', 'autisme_points_unge_layer', function(e) {
        const props = e.features[0].properties;
        console.log('Autisme unge properties:', props);
        let html = '<dl>';
        for (const key in props) {
          html += `<dt>${key}</dt><dd>${props[key]}</dd>`;
        }
        html += '</dl>';
        new mapboxgl.Popup({ offset: 15 })
          .setLngLat(e.lngLat)
          .setHTML(html)
          .addTo(map);
      });
      map.on('mouseenter', 'autisme_points_unge_layer', () => map.getCanvas().style.cursor = 'pointer');
      map.on('mouseleave', 'autisme_points_unge_layer', () => map.getCanvas().style.cursor = '');
      // 3D buildings
      const layers = map.getStyle().layers;
      let labelLayerId;
      for (const layer of layers) {
        if (layer.type === 'symbol' && layer.layout['text-field']) {
          labelLayerId = layer.id;
          break;
        }
      }
      map.addLayer({
        id: '3d-buildings',
        source: 'composite',
        'source-layer': 'building',
        filter: ['==', 'extrude', 'true'],
        type: 'fill-extrusion',
        minzoom: 15,
        paint: {
          'fill-extrusion-color': '#f3eee8',
          'fill-extrusion-height': ['interpolate', ['linear'], ['zoom'], 15, 0, 15.05, ['get', 'height']],
          'fill-extrusion-base': ['interpolate', ['linear'], ['zoom'], 15, 0, 15.05, ['get', 'min_height']],
          'fill-extrusion-opacity': 1
        }
      }, labelLayerId);

      // Dynamisk indlæsning af nye datalag med farver per type
   const tilbudstyper = {
     '104': 'rgb(13, 57, 168)',
     '105': 'rgb(69, 160, 252)',
     '107': 'rgb(183, 76, 255)',
     '108': '#9b278b',
     '108a': 'rgb(255, 68, 68)',
     '108s': '#ffc144'
   };

      Object.entries(tilbudstyper).forEach(([type, color]) => {
        const sourceId = `${type}_geocoded`;
        const layerId = `${type}_geocoded-layer`;

        map.addSource(sourceId, {
          type: 'geojson',
          data: `data/${type}.geojson`
        });

        map.addLayer({
          id: layerId,
          type: 'circle',
          source: sourceId,
          paint: {
            'circle-radius': ['case', ['boolean', ['feature-state','highlight'], false], 12, 6],
            'circle-color': color
          }
        });

        // Hent data til geocoder og popup (valgfrit, afhænger af behov)
        fetch(`data/${type}.geojson`)
          .then(res => res.ok ? res.json() : Promise.reject(`Fejl ved hentning af ${type}`))
          .then(geojson => {
            console.log(`Loaded ${type}`, geojson);

            if (type === '104') pointsData = geojson;
            if (type === '105') pointsData2 = geojson;
            if (type === '108') pointsData5 = geojson;
            if (type === '108a') pointsData6 = geojson;
            if (type === '108s') pointsData7 = geojson;
          })
          .catch(err => console.error(err));

        // Hover preview (mouseenter/leave) for hover-forhåndsvisning
        map.on('mouseenter', layerId, e => {
          map.getCanvas().style.cursor = 'pointer';

          // Remove any existing hover popup before creating a new one
          if (map.hoverPreviewPopup) {
            map.hoverPreviewPopup.remove();
            map.hoverPreviewPopup = null;
          }

          const features = map.queryRenderedFeatures(e.point, { layers: [layerId] });
          const coords = features[0].geometry.coordinates.slice();

          let html = '';
          if (features.length > 1) {
            html = `<div style="font-size:12px;"><strong>${features.length} tilbud</strong> ligger her</div>`;
          } else {
            const navn = features[0].properties?.Navn || 'Ukendt navn';
            html = `<div style="font-size:12px;"><strong>${navn}</strong></div>`;
          }

          // Vis popup
          const previewPopup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false,
            className: 'hover-popup',
            offset: 10
          })
          .setLngLat(coords)
          .setHTML(html)
          .addTo(map);

          map.hoverPreviewPopup = previewPopup;
        });

        map.on('mouseleave', layerId, () => {
          map.getCanvas().style.cursor = '';
          if (map.hoverPreviewPopup) {
            map.hoverPreviewPopup.remove();
            map.hoverPreviewPopup = null;
          }
        });

        map.on('click', layerId, e => {
          const features = map.queryRenderedFeatures(e.point, { layers: [layerId] });

          if (features.length > 1) {
            const htmlList = features.map((feature, idx) => {
              const navn = feature.properties?.Navn || `Ukendt ${idx+1}`;
              return `<div class="popup-item" data-idx="${idx}" style="cursor:pointer; margin-bottom:6px; color:#0066cc;">${navn}</div>`;
            }).join('');

            // Fjern tidligere popup hvis den findes (keep this only for multi-point case)
            document.querySelectorAll('.popup-list-left').forEach(el => el.remove());

            // Opret ny popup-liste til venstre
            const listContainer = document.createElement('div');
            listContainer.className = 'popup-list-left';
            listContainer.innerHTML = `
              <input class="popup-list-filter" placeholder="Filtrér…" />
              <button class="popup-list-close" aria-label="Luk popup">×</button>
              <strong style="display:block; margin-bottom:10px;">Flere tilbud her:</strong>
              ${htmlList}`;
            document.body.appendChild(listContainer);

            // Tilføj filterfunktionalitet
            const filterInput = listContainer.querySelector('.popup-list-filter');
            filterInput.addEventListener('input', e => {
              const q = e.target.value.toLowerCase();
              listContainer.querySelectorAll('.popup-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(q) ? 'block' : 'none';
              });
            });

            // Tilføj click handlers til listen
            setTimeout(() => {
              // Close button click handler
              listContainer.querySelector('.popup-list-close').addEventListener('click', () => {
                listContainer.remove();
              });
              const items = document.querySelectorAll('.popup-list-left .popup-item');
              items.forEach(item => {
                item.addEventListener('click', () => {
                  const idx = parseInt(item.getAttribute('data-idx'));
                  const f = features[idx];
                  const coords = f.geometry.coordinates.slice();
                  const props = { ...f.properties };
                  // --- Sectioned popup ---
                  let html = '<dl style="margin:0;">';
                  for (const k in props) {
                    let value = props[k];
                    if (typeof value === 'object' && value !== null) {
                      value = JSON.stringify(value, null, 2).replace(/\n/g, '<br>');
                    }
                    const label = k.replace(/_/g, ' ');
                    const capitalizedLabel = label.charAt(0).toUpperCase() + label.slice(1).toLowerCase();
                    if (capitalizedLabel.toLowerCase().includes('latitude') || capitalizedLabel.toLowerCase().includes('longitude')) continue;
                    html += `<dt style="font-weight:bold;">${capitalizedLabel}</dt><dd>${value}</dd>`;
                  }
                  html += '</dl>';
                  // Use global popup logic
                  if (currentPopup) {
                    currentPopup.remove();
                    document.body.classList.remove('popup-open');
                  }
                  currentPopup = new mapboxgl.Popup({ offset: 0, closeOnClick: false, anchor: 'center' })
                    .setLngLat(map.getCenter())
                    .setHTML(html)
                    .addTo(map);
                  document.body.classList.add('popup-open');
                  currentPopup.getElement().classList.add('central-popup');
                  // Highlight point
                  map.setFeatureState({ source: `${f.layer.source}`, id: f.id }, { highlight: true });
                  // Do NOT remove the left popup list here!
                  // document.querySelectorAll('.popup-list-left').forEach(el => el.remove());
                });
              });
            }, 100);
          } else if (features.length === 1) {
            // Do NOT remove the left popup-list here! (leave it if present)
            // document.querySelectorAll('.popup-list-left').forEach(el => el.remove());
            const feature = features[0];
            const coords = feature.geometry.coordinates.slice();
            const props = { ...feature.properties };
            let html = '<dl style="margin:0;">';
            for (const k in props) {
              let value = props[k];
              if (typeof value === 'object' && value !== null) {
                value = JSON.stringify(value, null, 2).replace(/\n/g, '<br>');
              }
              const label = k.replace(/_/g, ' ');
              const capitalizedLabel = label.charAt(0).toUpperCase() + label.slice(1).toLowerCase();
              if (capitalizedLabel.toLowerCase().includes('latitude') || capitalizedLabel.toLowerCase().includes('longitude')) continue;
              html += `<dt style="font-weight:bold;">${capitalizedLabel}</dt><dd>${value}</dd>`;
            }
            html += '</dl>';
            // Use global popup logic
            if (currentPopup) {
              currentPopup.remove();
              document.body.classList.remove('popup-open');
            }
            currentPopup = new mapboxgl.Popup({ offset: 0, closeOnClick: false, anchor: 'center' })
              .setLngLat(map.getCenter())
              .setHTML(html)
              .addTo(map);
            document.body.classList.add('popup-open');
            currentPopup.getElement().classList.add('central-popup');
            // Highlight point
            map.setFeatureState({ source: `${feature.layer.source}`, id: feature.id }, { highlight: true });
          }
        });
      });

          // Kontrollér at filerne findes, og giv notifikation hvis de mangler
          function showDataFileMissingNotification(filename) {
            // Simpel notifikation i toppen af siden
            let div = document.getElementById('data-file-warning');
            if (!div) {
              div = document.createElement('div');
              div.id = 'data-file-warning';
              div.style.position = 'fixed';
              div.style.top = '0';
              div.style.left = '0';
              div.style.right = '0';
              div.style.background = '#ffdddd';
              div.style.color = '#900';
              div.style.padding = '16px';
              div.style.zIndex = 2000;
              div.style.fontWeight = 'bold';
              div.style.textAlign = 'center';
              document.body.appendChild(div);
            }
            div.innerHTML += `<div>Filen <strong>${filename}</strong> mangler i <strong>data/</strong> mappen.</div>`;
          }

          // Først tjek for boliga_geocoded.geojson
          fetch('data/boliga_geocoded.geojson')
            .then(async res => {
              let geojson;
              if (!res.ok) throw new Error('missing');
              try {
                geojson = await res.json();
              } catch (e) {
                // Filen er tom eller ikke gyldig JSON
                geojson = null;
              }
              // Hvis geojson ikke er korrekt, indsæt dummy-data
              if (
                !geojson ||
                geojson.type !== 'FeatureCollection' ||
                !Array.isArray(geojson.features) ||
                geojson.features.length === 0 ||
                !geojson.features[0].geometry
              ) {
                geojson = {
                  "type": "FeatureCollection",
                  "features": [
                    {
                      "type": "Feature",
                      "geometry": {
                        "type": "Point",
                        "coordinates": [10.0, 56.0]
                      },
                      "properties": {
                        "Navn": "Test Boliga"
                      }
                    }
                  ]
                };
                // Overskriv filen på serveren hvis muligt (kun hvis backend tillader det)
                // Her kan man evt. vise en besked, men vi bruger bare dummy-data i browseren
                showDataFileMissingNotification('boliga_geocoded.geojson (indsætter dummy-indhold)');
              }
              map.addSource('boliga_geocoded', {
                type: 'geojson',
                data: geojson
              });
              map.addLayer({
                id: 'boliga_geocoded-layer',
                type: 'circle',
                source: 'boliga_geocoded',
                paint: {
                  'circle-radius': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    6, 3,
                    12, 6
                  ],
                  'circle-color': '#23bb08',
                  'circle-opacity': 0.5
                }
              }, labelLayerId);
              // Load boliga data for popups/highlight
              pointsData3 = geojson;
              // Cursor & popups for boliga
              map.on('mouseenter', 'boliga_geocoded-layer', () => map.getCanvas().style.cursor = 'pointer');
              map.on('mouseleave', 'boliga_geocoded-layer', () => map.getCanvas().style.cursor = '');
              map.on('click', 'boliga_geocoded-layer', e => {
                const feature = e.features[0];
                const coords = feature.geometry.coordinates.slice();
                const props = { ...feature.properties, id: feature.id };
                let html = '<dl style="margin:0;">';
                for (const k in props) {
                  let value = props[k];
                  if (typeof value === 'object' && value !== null) {
                    value = JSON.stringify(value, null, 2).replace(/\n/g, '<br>');
                  }
                  html += `<dt style="font-weight:bold;">${k}</dt><dd>${value}</dd>`;
                }
                html += '</dl>';
                new mapboxgl.Popup({ offset: 15 })
                  .setLngLat(coords)
                  .setHTML(html)
                  .addTo(map);
              });
              // Move layer below labelLayerId
              map.moveLayer('boliga_geocoded-layer', labelLayerId);
            })
            .catch(() => {
              // Filen findes ikke: brug dummy-data
              showDataFileMissingNotification('boliga_geocoded.geojson (indsætter dummy-indhold)');
              const dummyGeojson = {
                "type": "FeatureCollection",
                "features": [
                  {
                    "type": "Feature",
                    "geometry": {
                      "type": "Point",
                      "coordinates": [10.0, 56.0]
                    },
                    "properties": {
                      "Navn": "Test Boliga"
                    }
                  }
                ]
              };
              map.addSource('boliga_geocoded', {
                type: 'geojson',
                data: dummyGeojson
              });
              map.addLayer({
                id: 'boliga_geocoded-layer',
                type: 'circle',
                source: 'boliga_geocoded',
                paint: {
                  'circle-radius': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    6, 3,
                    12, 6
                  ],
                  'circle-color': '#23bb08',
                  'circle-opacity': 0.5
                }
              }, labelLayerId);
              pointsData3 = dummyGeojson;
              map.on('mouseenter', 'boliga_geocoded-layer', () => map.getCanvas().style.cursor = 'pointer');
              map.on('mouseleave', 'boliga_geocoded-layer', () => map.getCanvas().style.cursor = '');
              map.on('click', 'boliga_geocoded-layer', e => {
                const feature = e.features[0];
                const coords = feature.geometry.coordinates.slice();
                const props = { ...feature.properties, id: feature.id };
                let html = '<dl style="margin:0;">';
                for (const k in props) {
                  let value = props[k];
                  if (typeof value === 'object' && value !== null) {
                    value = JSON.stringify(value, null, 2).replace(/\n/g, '<br>');
                  }
                  html += `<dt style="font-weight:bold;">${k}</dt><dd>${value}</dd>`;
                }
                html += '</dl>';
                new mapboxgl.Popup({ offset: 15 })
                  .setLngLat(coords)
                  .setHTML(html)
                  .addTo(map);
              });
              map.moveLayer('boliga_geocoded-layer', labelLayerId);
            });

          // Dernæst tjek for ejendomstorvet_geocoded.geojson
          fetch('data/ejendomstorvet_geocoded.geojson')
            .then(async res => {
              let geojson;
              if (!res.ok) throw new Error('missing');
              try {
                geojson = await res.json();
              } catch (e) {
                geojson = null;
              }
              // Hvis geojson ikke er korrekt, indsæt dummy-data
              if (
                !geojson ||
                geojson.type !== 'FeatureCollection' ||
                !Array.isArray(geojson.features) ||
                geojson.features.length === 0 ||
                !geojson.features[0].geometry
              ) {
                geojson = {
                  "type": "FeatureCollection",
                  "features": [
                    {
                      "type": "Feature",
                      "geometry": {
                        "type": "Point",
                        "coordinates": [10.0, 56.0]
                      },
                      "properties": {
                        "Navn": "Test Boliga"
                      }
                    }
                  ]
                };
                showDataFileMissingNotification('ejendomstorvet_geocoded.geojson (indsætter dummy-indhold)');
              }
              map.addSource('ejendomstorvet_geocoded', {
                type: 'geojson',
                data: geojson
              });
              map.addLayer({
                id: 'ejendomstorvet_geocoded-layer',
                type: 'circle',
                source: 'ejendomstorvet_geocoded',
                paint: {
                  'circle-radius': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    6, 3,
                    12, 6
                  ],
                  'circle-color': '#ff9d25',
                  'circle-opacity': 0.5
                }
              }, labelLayerId);
              pointsData4 = geojson;
              map.on('mouseenter', 'ejendomstorvet_geocoded-layer', () => map.getCanvas().style.cursor = 'pointer');
              map.on('mouseleave', 'ejendomstorvet_geocoded-layer', () => map.getCanvas().style.cursor = '');
              map.on('click', 'ejendomstorvet_geocoded-layer', e => {
                const feature = e.features[0];
                const coords = feature.geometry.coordinates.slice();
                const props = { ...feature.properties, id: feature.id };
                let html = '<dl style="margin:0;">';
                for (const k in props) {
                  let value = props[k];
                  if (typeof value === 'object' && value !== null) {
                    value = JSON.stringify(value, null, 2).replace(/\n/g, '<br>');
                  }
                  html += `<dt style="font-weight:bold;">${k}</dt><dd>${value}</dd>`;
                }
                html += '</dl>';
                new mapboxgl.Popup({ offset: 15 })
                  .setLngLat(coords)
                  .setHTML(html)
                  .addTo(map);
              });
              map.moveLayer('ejendomstorvet_geocoded-layer', labelLayerId);
            })
            .catch(() => {
              showDataFileMissingNotification('ejendomstorvet_geocoded.geojson (indsætter dummy-indhold)');
              const dummyGeojson = {
                "type": "FeatureCollection",
                "features": [
                  {
                    "type": "Feature",
                    "geometry": {
                      "type": "Point",
                      "coordinates": [10.0, 56.0]
                    },
                    "properties": {
                      "Navn": "Test Boliga"
                    }
                  }
                ]
              };
              map.addSource('ejendomstorvet_geocoded', {
                type: 'geojson',
                data: dummyGeojson
              });
              map.addLayer({
                id: 'ejendomstorvet_geocoded-layer',
                type: 'circle',
                source: 'ejendomstorvet_geocoded',
                paint: {
                  'circle-radius': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    6, 3,
                    12, 6
                  ],
                  'circle-color': '#ff9d25',
                  'circle-opacity': 0.5
                }
              }, labelLayerId);
              pointsData4 = dummyGeojson;
              map.on('mouseenter', 'ejendomstorvet_geocoded-layer', () => map.getCanvas().style.cursor = 'pointer');
              map.on('mouseleave', 'ejendomstorvet_geocoded-layer', () => map.getCanvas().style.cursor = '');
              map.on('click', 'ejendomstorvet_geocoded-layer', e => {
                const feature = e.features[0];
                const coords = feature.geometry.coordinates.slice();
                const props = { ...feature.properties, id: feature.id };
                let html = '<dl style="margin:0;">';
                for (const k in props) {
                  let value = props[k];
                  if (typeof value === 'object' && value !== null) {
                    value = JSON.stringify(value, null, 2).replace(/\n/g, '<br>');
                  }
                  html += `<dt style="font-weight:bold;">${k}</dt><dd>${value}</dd>`;
                }
                html += '</dl>';
                new mapboxgl.Popup({ offset: 15 })
                  .setLngLat(coords)
                  .setHTML(html)
                  .addTo(map);
              });
              map.moveLayer('ejendomstorvet_geocoded-layer', labelLayerId);
            });

          // Ny geocoder result logik: find og filtrer på kommune, flyt kortet (mere robust match)
          geocoder.on('result', ev => {
            const result = ev.result;
            if (result.properties && result.properties.filterType === 'kommune') {
              applyFilterToAllLayers('Kommune', result.place_name);

              // --- Inserted logic: show popup list of all tilbud in selected kommune ---
              document.querySelectorAll('.popup-list-left').forEach(el => el.remove());

              const sources = [pointsData, pointsData2, pointsData5, pointsData6, pointsData7];
              const kommuneName = result.place_name;
              let matching = [];

              sources.forEach(source => {
                if (!source || !source.features) return;
                source.features.forEach((feature, idx) => {
                  const kommune = feature.properties?.Kommune;
                  if (kommune === kommuneName) matching.push(feature);
                });
              });

              if (matching.length > 0) {
                const htmlList = matching.map((feature, idx) => {
                  const navn = feature.properties?.Navn || `Ukendt ${idx+1}`;
                  return `<div class="popup-item" data-idx="${idx}" style="cursor:pointer; margin-bottom:6px; color:#0066cc;">${navn}</div>`;
                }).join('');

                const listContainer = document.createElement('div');
                listContainer.className = 'popup-list-left';
                listContainer.innerHTML = `
                  <input class="popup-list-filter" placeholder="Filtrér…" />
                  <button class="popup-list-close" aria-label="Luk popup">×</button>
                  <strong style="display:block; margin-bottom:10px;">Tilbud i ${kommuneName}:</strong>
                  ${htmlList}`;
                document.body.appendChild(listContainer);

                // Tilføj filterfunktionalitet
                const filterInput = listContainer.querySelector('.popup-list-filter');
                filterInput.addEventListener('input', e => {
                  const q = e.target.value.toLowerCase();
                  listContainer.querySelectorAll('.popup-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(q) ? 'block' : 'none';
                  });
                });

                setTimeout(() => {
                  listContainer.querySelector('.popup-list-close').addEventListener('click', () => {
                    listContainer.remove();
                  });
                  const items = document.querySelectorAll('.popup-list-left .popup-item');
              items.forEach((item, idx) => {
                item.addEventListener('click', () => {
                  const f = matching[idx];
                  const props = { ...f.properties };
                  let html = '<dl style="margin:0;">';
                  for (const k in props) {
                    let value = props[k];
                    if (typeof value === 'object' && value !== null) {
                      value = JSON.stringify(value, null, 2).replace(/\n/g, '<br>');
                    }
                    const label = k.replace(/_/g, ' ');
                    const capitalizedLabel = label.charAt(0).toUpperCase() + label.slice(1).toLowerCase();
                    if (capitalizedLabel.toLowerCase().includes('latitude') || capitalizedLabel.toLowerCase().includes('longitude')) continue;
                    html += `<dt style="font-weight:bold;">${capitalizedLabel}</dt><dd>${value}</dd>`;
                  }
                  html += '</dl>';
                  // Use global popup logic
                  if (currentPopup) {
                    currentPopup.remove();
                    document.body.classList.remove('popup-open');
                  }
                  currentPopup = new mapboxgl.Popup({ offset: 0, closeOnClick: false, anchor: 'center' })
                    .setLngLat(map.getCenter())
                    .setHTML(html)
                    .addTo(map);
                  document.body.classList.add('popup-open');
                  currentPopup.getElement().classList.add('central-popup');
                  // Highlight point
                  map.setFeatureState({ source: `${f.layer.source}`, id: f.id }, { highlight: true });
                });
              });
                }, 100);
              } else {
                // Ingen tilbud fundet i kommunen
                const info = document.createElement('div');
                info.className = 'popup-list-left';
                info.innerHTML = `
                  <button class="popup-list-close" aria-label="Luk popup">×</button>
                  <div>Ingen tilbud fundet i <strong>${kommuneName}</strong>.</div>`;
                document.body.appendChild(info);
                setTimeout(() => {
                  info.querySelector('.popup-list-close').addEventListener('click', () => info.remove());
                }, 100);
              }
              // --- end inserted logic ---
            }
            if (result.properties && result.properties.filterType === 'botilbud') {
              map.flyTo({ center: result.center, zoom: 14 });
            } else if (result.center && Array.isArray(result.center)) {
              // Flyt kortet til center
              map.flyTo({ center: result.center, zoom: 10 });
            }
            // Lyt på ændringer i geocoder søgefeltet og nulstil filter hvis feltet bliver tomt
            const inputField = document.querySelector('.mapboxgl-ctrl-geocoder input');
            if (inputField) {
              inputField.addEventListener('input', function () {
                if (this.value.trim() === '') {
                  console.log('Søgefelt er tomt – nulstiller kommune-filter');
                  applyFilterToAllLayers('Kommune', '');
                }
              });
            }
            // Lyt efter klik på Clear-knappen for at nulstille kommune-filter og flyt kortet til default
            const clearButton = document.querySelector('.mapboxgl-ctrl-geocoder--button');
            if (clearButton) {
              clearButton.addEventListener('click', () => {
                console.log('Clear-knap trykket – nulstiller kommune-filter og zoomer ud');
                applyFilterToAllLayers('Kommune', '');
                map.flyTo({ center: [10.0, 56.0], zoom: 6 });
              });
            }
          });

        // (moved kommuneDropdown and event handlers to DOMContentLoaded above)
      });

        // Toggle visibility for Boliga and Ejendomstorvet layers via external buttons
        // (now handled above with expanded layerVisibility and handleToggleClick)
  </script>
</script>
</body>4
</html>